<%- contentFor('body') %>
<div class="w-full">
  <h1 class="text-3xl font-bold mb-4">Select Host to View Logs</h1>
  <div class="mb-4">
    <% hosts.forEach(host => { %>
      <button onclick="viewLogs('<%= host.name %>')" class="btn btn-primary mr-2">
        <%= host.name %>
      </button>
    <% }); %>
  </div>
  <div class="container">
    <div id="log" class="w-full bg-gray-900 text-gray-200 text-xs p-3 h-[600px] overflow-y-scroll font-mono whitespace-pre-wrap break-words"></div>
  </div>
</div>

<script>
let currentEventSource = null;

function viewLogs(hostName) {
  const logElement = document.getElementById('log');
  logElement.innerHTML = '正在連接...';
  
  // 如果已有連接，先關閉
  if (currentEventSource) {
    currentEventSource.close();
  }
  
  // 使用新的 API 路徑
  const eventSource = new EventSource(`/api/logs?host=${encodeURIComponent(hostName)}`, {
    withCredentials: true
  });
  
  currentEventSource = eventSource;
  
  eventSource.onmessage = function(event) {
    if (logElement.innerHTML === '正在連接...') {
      logElement.innerHTML = '';
    }
    const newLog = document.createElement('div');
    newLog.textContent = event.data;
    logElement.appendChild(newLog);
    logElement.scrollTop = logElement.scrollHeight;
  };
  
  eventSource.onerror = function(error) {
    console.error('EventSource failed:', error);
    if (currentEventSource) {
      currentEventSource.close();
      currentEventSource = null;
      if (logElement.innerHTML === '正在連接...') {
        logElement.innerHTML = '連接失敗';
      } else {
        logElement.innerHTML += '\n連接已關閉';
      }
    }
  };
}
</script>

<%- include('partials/logs-script') %>
