<%- contentFor('body') %>
<div class="w-full">
  <h1 class="text-3xl font-bold mb-4">Select Host to View Logs</h1>
  <div class="mb-4">
    <%# 檢查 hosts 是否存在且為陣列 %>
    <% if (Array.isArray(hosts) && hosts.length > 0) { %>
      <% hosts.forEach(host => { %>
        <button onclick="viewLogs('<%= host.host_name %>')" class="btn btn-primary mr-2">
          <%= host.container_name %> (<%= host.host %>)
        </button>
      <% }); %>
    <% } else { %>
      <div class="alert alert-warning">
        No containers found. Please add containers in settings.
      </div>
    <% } %>
  </div>
  <div class="container">
    <div id="log" class="w-full bg-gray-900 text-gray-200 text-xs p-3 h-[600px] overflow-y-scroll font-mono whitespace-pre-wrap break-words"></div>
  </div>
</div>

<script>
let currentEventSource = null;
function viewLogs(hostName) {
  console.log('Viewing logs for host:', hostName); // 新增除錯日誌
  const logElement = document.getElementById('log');
  logElement.innerHTML = '正在連接...';
  
  // 如果已有連接，先關閉
  if (currentEventSource) {
    currentEventSource.close();
  }
  
  // 使用新的 API 路徑
  const eventSource = new EventSource(`/api/container/logs?host=${encodeURIComponent(hostName)}`, {
    withCredentials: true
  });
  
  currentEventSource = eventSource;
  
  eventSource.onmessage = function(event) {
    if (logElement.innerHTML === '正在連接...') {
      logElement.innerHTML = '';
    }
    const newLog = document.createElement('div');
    newLog.innerHTML = event.data; // 使用 innerHTML 以支援著色
    logElement.appendChild(newLog);
    
    // 滾動到底部
    logElement.scrollTop = logElement.scrollHeight;
  };
  
  eventSource.onerror = function(error) {
    console.error('EventSource failed:', error);
    if (currentEventSource) {
      currentEventSource.close();
      currentEventSource = null;
      logElement.innerHTML += '<div class="text-red-500">連接已關閉</div>';
    }
  };
}

// 頁面卸載時清理連接
window.addEventListener('beforeunload', () => {
  if (currentEventSource) {
    currentEventSource.close();
  }
});
</script>

<%- include('partials/logs-script') %>
