<%- contentFor('body') %>
<div class="w-full">
  <h1 class="text-3xl font-bold mb-4">Select Host to View Logs</h1>
  
  <!-- 新增標籤篩選器 -->
  <div class="mb-4">
    <select id="tagFilter" class="select select-bordered w-full max-w-xs" onchange="filterByTag(this.value)">
      <option value="">所有標籤</option>
      <% if (Array.isArray(tags)) { %>
        <% tags.forEach(tag => { %>
          <option value="<%= tag %>"><%= tag %></option>
        <% }); %>
      <% } %>
    </select>
  </div>

  <div class="mb-4" id="hostButtons">
    <% if (Array.isArray(hosts) && hosts.length > 0) { %>
      <% hosts.forEach(host => { %>
        <button onclick="viewLogs('<%= host.host_name %>')" 
                class="btn btn-primary mr-2 mb-2 host-button"
                data-tags="<%= host.tags %>">
          <%= host.container_name %> (<%= host.host %>)
          <% if (host.tags) { %>
            <span class="ml-2 text-xs bg-base-200 px-2 py-1 rounded-full text-white">
              <%= host.tags %>
            </span>
          <% } %>
        </button>
      <% }); %>
    <% } %>
  </div>

  <div class="container">
    <div id="log" class="w-full bg-gray-900 text-gray-200 text-xs p-3 h-[600px] overflow-y-scroll font-mono whitespace-pre-wrap break-words"></div>
  </div>
</div>

<script>
let currentEventSource = null;
function viewLogs(hostName) {
  console.log('Viewing logs for host:', hostName); // 新增除錯日誌
  const logElement = document.getElementById('log');
  logElement.innerHTML = '正在連接...';
  
  // 如果已有連接，先關閉
  if (currentEventSource) {
    currentEventSource.close();
  }
  
  // 使用新的 API 路徑
  const eventSource = new EventSource(`/api/container/logs?host=${encodeURIComponent(hostName)}`, {
    withCredentials: true
  });
  
  currentEventSource = eventSource;
  
  eventSource.onmessage = function(event) {
    if (logElement.innerHTML === '正在連接...') {
      logElement.innerHTML = '';
    }
    const newLog = document.createElement('div');
    newLog.innerHTML = event.data; // 使用 innerHTML 以支援著色
    logElement.appendChild(newLog);
    
    // 滾動到底部
    logElement.scrollTop = logElement.scrollHeight;
  };
  
  eventSource.onerror = function(error) {
    console.error('EventSource failed:', error);
    if (currentEventSource) {
      currentEventSource.close();
      currentEventSource = null;
      logElement.innerHTML += '<div class="text-red-500">連接已關閉</div>';
    }
  };
}

// 頁面卸載時清理連接
window.addEventListener('beforeunload', () => {
  if (currentEventSource) {
    currentEventSource.close();
  }
});

function filterByTag(selectedTag) {
  const buttons = document.querySelectorAll('.host-button');
  buttons.forEach(button => {
    const buttonTags = button.getAttribute('data-tags');
    if (!selectedTag || buttonTags === selectedTag) {
      button.style.display = '';
    } else {
      button.style.display = 'none';
    }
  });
}
</script>

<%- include('partials/logs-script') %>
