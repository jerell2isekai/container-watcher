<script>
  function convertAnsiToHtml(text) {
    let result = text;
    let stack = [];
    
    result = result.replace(/\x1B\[([0-9;]+)m/g, function(match, p1) {
      const codes = p1.split(';');
      let html = '';
      
      codes.forEach(code => {
        code = parseInt(code);
        if (code === 0) {
          // Reset
          while (stack.length > 0) {
            html += '</span>';
            stack.pop();
          }
        } else if (code === 1) {
          html += '<span style="font-weight:bold">';
          stack.push('bold');
        } else if (code === 3) {
          html += '<span style="font-style:italic">';
          stack.push('italic');
        } else if (code === 4) {
          html += '<span style="text-decoration:underline">';
          stack.push('underline');
        } else {
          let color = '';
          if (code >= 30 && code <= 37) {
            color = `ansi-${getColorName(code - 30)}-fg`;
          } else if (code >= 40 && code <= 47) {
            color = `ansi-${getColorName(code - 40)}-bg`;
          } else if (code >= 90 && code <= 97) {
            color = `ansi-bright-${getColorName(code - 90)}-fg`;
          }
          if (color) {
            html += `<span class="${color}">`;
            stack.push(color);
          }
        }
      });
      
      return html;
    });
    
    while (stack.length > 0) {
      result += '</span>';
      stack.pop();
    }
    
    return result;
  }

  function getColorName(code) {
    const colors = ['black', 'red', 'green', 'yellow', 'blue', 'magenta', 'cyan', 'white'];
    return colors[code];
  }

  function colorizeLogMessage(message) {
    const parts = message.split(' | ');
    if (parts.length < 2) return message;

    const timestamp = parts[0];
    const level = parts[1];
    const restMessage = parts.slice(2).join(' | ');

    let coloredMessage = restMessage;

    // 調整後的顏色方案 - 更明亮更易讀
    const methodColorMap = {
      'GET': '#00ff00',     // 亮綠
      'POST': '#3b82f6',    // 亮藍
      'PUT': '#ffd700',     // 金黃
      'DELETE': '#ff4444',  // 亮紅
      'PATCH': '#ff00ff',   // 亮紫
      'OPTIONS': '#00ffff'  // 亮青
    };

    // 替換 HTTP 方法和 API 路徑
    Object.entries(methodColorMap).forEach(([method, color]) => {
      coloredMessage = coloredMessage.replace(
        new RegExp(`(${method})\\s+(/[^\\s|]+)`, 'g'), 
        (match, m, path) => `<span style="color: ${color}">${m}</span> <span style="color: #87ceeb">${path}</span>`
      );
    });

    // 狀態碼著色
    coloredMessage = coloredMessage.replace(
      /Status: (\d+)/g,
      (match, code) => {
        const color = code >= 400 ? '#ff4444' : // 亮紅
                     code >= 300 ? '#ffd700' : // 金黃
                     '#00ff00';  // 亮綠
        return `Status: <span style="color: ${color}">${code}</span>`;
      }
    );

    // Origin 著色
    const validOrigins = [
      'https://boanhealth.com',
      'https://dev.boanhealth.com',
      'http://localhost:3000'
    ];
    coloredMessage = coloredMessage.replace(
      /Origin: ([^,\n]+)/g,
      (match, origin) => {
        const color = origin.includes('Unknown') ? '#ffd700' : // 金黃
                     validOrigins.some(valid => origin.includes(valid)) ? '#00ff00' : // 亮綠
                     '#ffffff'; // 白色
        return `Origin: <span style="color: ${color}">${origin}</span>`;
      }
    );

    // IP 著色
    coloredMessage = coloredMessage.replace(
      /(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|Unknown IP)/g,
      `<span style="color: #ffa07a">$1</span>` // 亮鮭魚色
    );

    return `<span style="color: #ffffff">${timestamp} | ${level}</span> | ${coloredMessage}`;
  }
  
  function viewLogs(host) {
    const logDiv = document.getElementById('log');
    logDiv.innerHTML = '正在連接...';
    
    // 如果已有連接，先關閉舊的
    if (window.currentEventSource) {
      window.currentEventSource.close();
    }
    
    // 使用新的 API 路徑
    const source = new EventSource(`/api/container/logs?host=${encodeURIComponent(host)}`, {
      withCredentials: true
    });
    window.currentEventSource = source;
    
    source.onmessage = function(event) {
      const newLog = document.createElement('div');
      newLog.innerHTML = colorizeLogMessage(event.data);
      logDiv.appendChild(newLog);
      
      // 限制日誌數量
      while (logDiv.children.length > 1000) {
        logDiv.removeChild(logDiv.firstChild);
      }
      
      // 自動滾動到底部
      if (logDiv.scrollTop + logDiv.clientHeight >= logDiv.scrollHeight - 100) {
        logDiv.scrollTop = logDiv.scrollHeight;
      }
    };

    source.onerror = function(event) {
      console.error('EventSource failed:', event);
      source.close();
      window.currentEventSource = null;
      logDiv.innerHTML += '<div style="color: #ff4444">連接已關閉</div>';
    };
  }

  // 在頁面卸載時清理連接
  window.addEventListener('beforeunload', () => {
    if (window.currentEventSource) {
      window.currentEventSource.close();
    }
  });
</script>
